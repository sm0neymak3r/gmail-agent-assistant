# Infrastructure Development Guide

This document provides guidance for AI assistants and developers working with the Gmail Agent Terraform infrastructure.

## Quick Start

Before making any changes:
1. Read `REFERENCE.md` for detailed documentation of all resources
2. Understand the naming conventions and patterns used
3. Always test with `terraform plan` before applying

## Terraform Strategy

### State Management

- **Backend**: GCS bucket (`gmail-agent-terraform-state`)
- **Workspaces**: Used for environment separation (dev/staging/prod)
- **State Locking**: Automatic via GCS

```bash
# Always authenticate first
export GOOGLE_APPLICATION_CREDENTIALS="$HOME/gmail-agent-keys/terraform-sa-key.json"

# Check current workspace
terraform workspace show

# Switch environments
terraform workspace select dev
```

### Resource Organization

Files are organized by concern:

| File | Responsibility |
|------|----------------|
| `versions.tf` | Terraform/provider versions, backend config |
| `variables.tf` | Input variables with defaults |
| `network.tf` | VPC, subnets, NAT, VPC connector |
| `database.tf` | Cloud SQL instance, database, user |
| `database_schema.tf` | SQL schema generation |
| `secrets.tf` | Secret Manager resources and IAM |
| `registry.tf` | Artifact Registry for Docker images |
| `cloudrun.tf` | Cloud Run service configuration |
| `scheduler.tf` | Cloud Scheduler for periodic jobs |
| `monitoring.tf` | Logging, alerting, storage |
| `outputs.tf` | Exposed values after deployment |

### Naming Conventions

All resources follow the pattern: `{resource-type}-{environment}`

Examples:
- `gmail-agent-vpc-dev`
- `gmail-agent-db-staging`
- `anthropic-api-key-prod`

**Important**: The `{environment}` suffix comes from `var.environment`, which is set per workspace.

### Environment-Specific Configuration

Resources adapt to environment via conditionals:

```hcl
# Example: HA only in production
availability_type = var.environment == "prod" ? "REGIONAL" : "ZONAL"

# Example: Allow destroy in non-prod
force_destroy = var.environment != "prod"
```

## Common Tasks

### Adding a New Secret

1. **If secret already exists in Secret Manager** (created outside Terraform):
   ```hcl
   # In secrets.tf - use data source
   data "google_secret_manager_secret" "my_secret" {
     secret_id = "my-secret-name"
   }
   ```

2. **If Terraform should create the secret**:
   ```hcl
   # In secrets.tf - use resource
   resource "google_secret_manager_secret" "my_secret" {
     secret_id = "my-secret-${var.environment}"
     replication { auto {} }
   }
   ```

3. **Grant access to runtime service account**:
   ```hcl
   resource "google_secret_manager_secret_iam_member" "my_secret_access" {
     secret_id = <data_or_resource>.my_secret.id
     role      = "roles/secretmanager.secretAccessor"
     member    = "serviceAccount:email-agent-runtime@${var.project_id}.iam.gserviceaccount.com"
   }
   ```

4. **Add to Cloud Run environment**:
   ```hcl
   # In cloudrun.tf, inside containers block
   env {
     name = "MY_SECRET"
     value_source {
       secret_key_ref {
         secret  = <data_or_resource>.my_secret.secret_id
         version = "latest"
       }
     }
   }
   ```

### Adding a New Environment Variable

For non-secret values, add directly to cloudrun.tf:

```hcl
env {
  name  = "MY_VARIABLE"
  value = "my-value"  # or var.my_variable
}
```

### Modifying Cloud Run Resources

Update variables in `terraform.tfvars` or pass via command line:

```bash
terraform apply -var="cloudrun_cpu=4" -var="cloudrun_memory=8Gi"
```

### Adding a New API Dependency

1. Enable the API in GCP Console or via gcloud
2. Document in `REFERENCE.md` under "Quick Reference: APIs Required"
3. Add any IAM bindings if needed

## Secret Handling Guidelines

### Types of Secrets

| Type | Storage | Format | Notes |
|------|---------|--------|-------|
| OAuth Client | `gmail-oauth-token` | JSON | App identity, rarely changes |
| User Tokens | `gmail-user-token` | JSON | May need refresh token rotation |
| API Keys | `anthropic-api-key-{env}` | String | Environment-specific |
| DB Password | `db-password-{env}` | String | Auto-generated by Terraform |

### Secret Format Requirements

- **Environment variables require UTF-8**: No binary data
- **JSON secrets**: Must be valid, parseable JSON
- **String secrets**: Plain text, no newlines at end

### Updating Secrets

```bash
# Add new version (keeps old versions)
echo -n "new-value" | gcloud secrets versions add SECRET_NAME --data-file=-

# For JSON files
gcloud secrets versions add SECRET_NAME --data-file=path/to/file.json
```

## Debugging Common Issues

### "Secret contains non-UTF8 data"

Cloud Run environment variables must be UTF-8. Solutions:
1. Re-encode the secret as valid UTF-8/JSON
2. Mount as volume instead of env var (see cloudrun.tf volume example)

### "API not enabled"

```bash
gcloud services enable API_NAME.googleapis.com
```

Wait 1-2 minutes for propagation, then retry.

### "Permission denied on secret"

Check IAM binding exists:
```bash
gcloud secrets get-iam-policy SECRET_NAME
```

Ensure `email-agent-runtime@PROJECT.iam.gserviceaccount.com` has `secretAccessor` role.

### Cloud Run won't start

Check logs:
```bash
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=gmail-agent-dev" --limit=20
```

Common causes:
- Missing secret versions (secret exists but has no value)
- Invalid secret format
- Container image issues

## Architecture Decisions

### Why Private Service Connect for Cloud SQL?

- No public IP exposure
- Traffic stays within Google's network
- Required for production security compliance

### Why Serverless VPC Connector?

- Cloud Run is serverless, needs bridge to VPC
- Enables private Cloud SQL access
- NAT provides outbound internet for external APIs

### Why Separate OAuth Secrets?

- `gmail-oauth-token`: Client credentials (app identity) - stable
- `gmail-user-token`: User tokens (access/refresh) - may rotate
- Separation allows independent updates and clearer debugging

### Why Anthropic Only?

- Single provider simplifies key management
- Claude Haiku available for fast/cheap tasks
- Claude Sonnet for complex reasoning
- Single API key works for all Claude models

## Future Considerations

### Before Production Deployment

1. Set `deletion_protection = true` on Cloud SQL
2. Configure notification channels for alerts
3. Review IAM permissions (principle of least privilege)
4. Enable Cloud SQL PITR (Point-in-Time Recovery)
5. Consider Cloud Armor for DDoS protection

### Potential Enhancements

- **Pub/Sub Integration**: For real-time Gmail push notifications
- **Cloud Tasks**: For async processing queue
- **Memorystore (Redis)**: For caching/rate limiting
- **Cloud CDN**: If serving static assets

## Reference

- **REFERENCE.md**: Complete resource dictionary
- **README.md**: Quick start and common operations
- **terraform.tfvars.example**: Example configuration values

## Commands Cheat Sheet

```bash
# Authenticate
export GOOGLE_APPLICATION_CREDENTIALS="$HOME/gmail-agent-keys/terraform-sa-key.json"

# Plan changes
terraform plan

# Apply changes
terraform apply

# Show current state
terraform show

# List resources
terraform state list

# View specific resource
terraform state show google_cloud_run_v2_service.main

# Import existing resource
terraform import google_secret_manager_secret.my_secret projects/PROJECT/secrets/SECRET

# Refresh state from actual infrastructure
terraform refresh

# Format all .tf files
terraform fmt

# Validate configuration
terraform validate
```
